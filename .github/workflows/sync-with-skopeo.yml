name: Sync image to Docker Hub (skopeo)

on:
  workflow_dispatch:
    inputs:
      dockerImageTag:
        description: 'Docker Image Tag'
        default: 'dev'
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Copy image with skopeo
        env:
          TAG: ${{ github.event.inputs.dockerImageTag }}
          SRC: ${{ secrets.FIT2CLOUD_REGISTRY_HOST }}/cordys/cordys-crm-ce:${{ github.event.inputs.dockerImageTag }}
          DEST: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/cordyscrm:${{ github.event.inputs.dockerImageTag }}
          SRC_USER: ${{ secrets.FIT2CLOUD_REGISTRY_USERNAME }}
          SRC_PASSWORD: ${{ secrets.FIT2CLOUD_REGISTRY_PASSWORD }}
          DEST_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DEST_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          docker run --rm --entrypoint skopeo quay.io/skopeo/stable:v1.15.0 \
            copy \
            --src-creds "${SRC_USER}:${SRC_PASSWORD}" \
            --dest-creds "${DEST_USER}:${DEST_TOKEN}" \
            docker://${SRC} docker://${DEST}
