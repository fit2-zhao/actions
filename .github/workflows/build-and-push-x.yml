name: Build and Push CE & EE Images

on:
  workflow_dispatch:
    inputs:
      dockerImageTag:
        description: 'Docker Image Tag'
        required: true
        default: 'dev'
      architecture:
        description: 'Target Architecture'
        required: true
        default: 'linux/amd64'
        type: choice
        options:
          - linux/amd64
          - linux/arm64
          - linux/amd64,linux/arm64

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ${{ secrets.FIT2CLOUD_REGISTRY_HOST }}
      CE_IMAGE: ${{ secrets.FIT2CLOUD_REGISTRY_HOST }}/cordys/cordys-crm-ce
      EE_IMAGE: ${{ secrets.FIT2CLOUD_REGISTRY_HOST }}/cordys/cordys-crm-ee
      TAG: ${{ github.event.inputs.dockerImageTag }}
      PLATFORMS: ${{ github.event.inputs.architecture }}

    steps:
      # 0. 安装 Java 21 并开启 Maven 缓存（显式指定 pom 路径）
      - name: Set up Java 21 & Cache Maven
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
          cache-dependency-path: |
            cordys-crm/pom.xml
            cordys-crm-xpack/pom.xml

      # 1. Checkout CE 源码
      - name: Checkout CE Repository
        uses: actions/checkout@v3
        with:
          repository: cordys-dev/cordys-crm
          token: ${{ secrets.GH_TOKEN }}
          path: cordys-crm

      # 2. 构建并安装 CE 到本地 Maven 仓库，跳过 frontend
      - name: Build & Install CE
        working-directory: cordys-crm
        run: |
          ./mvnw install -N
          ./mvnw clean package -DskipTests -pl '!frontend' -am -B

      # 3. Checkout EE 源码（xpack）
      - name: Checkout EE (XPack) Repository
        uses: actions/checkout@v3
        with:
          repository: cordys-dev/cordys-crm-xpack
          token: ${{ secrets.GH_TOKEN }}
          path: cordys-crm-xpack

      # 4. 编译 EE JAR
      - name: Build XPack JAR
        working-directory: cordys-crm-xpack
        run: |
          ./mvnw clean package -DskipTests -B

      # 5. 配置 QEMU 与 Buildx
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. 登录 Docker Registry
      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.FIT2CLOUD_REGISTRY_USERNAME }}
          password: ${{ secrets.FIT2CLOUD_REGISTRY_PASSWORD }}

      # 7. 构建并推送 CE 镜像
      - name: Build & Push CE Image
        working-directory: cordys-crm
        run: |
          if [[ "${TAG}" == "dev" ]]; then
            CE_TAGS="--tag ${CE_IMAGE}:${TAG}"
          else
            CE_TAGS="--tag ${CE_IMAGE}:${TAG} --tag ${CE_IMAGE}:latest"
          fi
          docker buildx build \
            --platform ${PLATFORMS} \
            ${CE_TAGS} \
            --build-arg CRM_VERSION=${TAG}-$(git -C cordys-crm rev-parse --short HEAD) \
            --push \
            -f installer/Dockerfile .

      # 8. 构建并推送 EE 镜像（基于 CE commit 容器）
      - name: Build & Push EE Image
        run: |
          JAR=$(ls cordys-crm-xpack/target/*.jar | head -n1)
          docker pull ${CE_IMAGE}:${TAG}
          docker create --name temp-ce ${CE_IMAGE}:${TAG}
          docker cp "$JAR" temp-ce:/app/lib/cordys-crm-xpack.jar
          docker commit temp-ce ${EE_IMAGE}:${TAG}
          docker push ${EE_IMAGE}:${TAG}
          docker rm temp-ce

      # 9. 重新创建 Git Tag（仅当 TAG ≠ dev）
      - name: Recreate Git Tag
        if: success() && github.event.inputs.dockerImageTag != 'dev'
        run: |
          git config --global user.name 'fit2-zhao'
          git config --global user.email 'yong.zhao@fit2cloud.com'
          git fetch --prune --tags
          if git tag -l "${TAG}"; then
            git tag -d "${TAG}"
            git push --delete origin "${TAG}"
          fi
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"
